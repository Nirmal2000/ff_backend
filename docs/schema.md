# Skin Analysis Task Storage

The backend now persists every workflow run inside a single `skin_analysis_tasks` table. Each row represents one request coming from the authenticated user and keeps the entire JSON payload generated by the pipeline inside a `jsonb` column. The backend only ever mutates the `status`, `result`, and `error` fields, so the API responses still match `{ task_id }` and `{ task_id, status, result, error }`.

## Suggested Table Definition

```sql
-- Enable pgcrypto to access gen_random_uuid if it is not already enabled.
create extension if not exists pgcrypto;

create table if not exists public.skin_analysis_tasks (
    id uuid primary key default gen_random_uuid(),
    user_id uuid not null references auth.users (id) on delete cascade,
    status text not null default 'queued',
    result jsonb,
    error text,
    real_age integer,
    intake jsonb,
    routine_json jsonb,
    created_at timestamptz not null default now(),
    updated_at timestamptz not null default now()
);

create or replace function public.set_updated_at()
returns trigger as $$
begin
    new.updated_at = now();
    return new;
end;
$$ language plpgsql;

drop trigger if exists trg_skin_analysis_tasks_updated_at on public.skin_analysis_tasks;
create trigger trg_skin_analysis_tasks_updated_at
before update on public.skin_analysis_tasks
for each row execute function public.set_updated_at();

alter table public.skin_analysis_tasks enable row level security;

create policy "Users manage their own skin analysis tasks"
    on public.skin_analysis_tasks
    for all
    using (auth.uid() = user_id)
    with check (auth.uid() = user_id);
```

With Row Level Security enabled, Supabase will only return rows that belong to the caller, and the backend still enforces the `user_id` match as a final safeguard.

The `result` column holds the raw face-analysis output. The optional `intake` column keeps the post-analysis form data, and `routine_json` stores the final structured recommendation that's exposed via `/tasks/{id}`. All JSON-heavy columns (`result`, `intake`, and `routine_json`) should stay `jsonb` to avoid schema fragmentation.
